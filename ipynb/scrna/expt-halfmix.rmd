```{r}
library(Seurat)
library(magrittr)
library(ggplot2)
library(cowplot)
theme_set(theme_bw())

library(AnnotationDbi)
library(org.Hs.eg.db)

src_files <- list.files("R", full.names = TRUE)
for (f in src_files) {
  source(f)
  cat(sprintf('Sourced file: %s\n', f))
}
```
```{r}
halfmix <- readRDS("data/293t_jurkat/processed/halfmix.rds")
```
# QC
```{r}
FeatureScatter(
  halfmix_sub,
  feature1 = "nCount_RNA", feature2 = "nFeature_RNA",
  group.by = "celltype"
)
FeatureScatter(
  halfmix_sub,
  feature1 = "nCount_RNA", feature2 = "percent_ribo",
  group.by = "celltype"
)
```
```{r}
ax <- VlnPlot(
  halfmix,
  features = c("nFeature_RNA", "nCount_RNA"),
  group.by = "celltype",
  pt.size = .2
)
ax
# file <- "tmp/halfmix_celltype-nfeature.png"
# ggsave(file, ax, width = 6, height = 6)
```
- Only ribo genes present, no mito genes
```{r}
# Map ensembl id to gene symbol
mapping <- mapIds(
  org.Hs.eg.db,
  keys = rownames(halfmix),
  keytype = "ENSEMBL",
  column = "SYMBOL"
)
print(sum(grepl("^MT-", mapping)))
ribo_genes <- rownames(halfmix)[grep("^RP[SL]", mapping)]
halfmix$percent_ribo <-
  colSums(GetAssayData(halfmix, slot = "counts")[ribo_genes, ]) /
  halfmix$nCount_RNA
```
```{r}
halfmix_sub <- subset(
  halfmix,
  subset = nFeature_RNA > 1500 & percent_ribo > 0.2 &
    nCount_RNA > 2000 & nCount_RNA < 4e4
)
table(halfmix_sub$batch, halfmix_sub$celltype)
halfmix_sub <- NormalizeData(halfmix_sub, normalization.method = "LogNormalize")
```
```{r}
# TODO: select features
# remove ribo genes
# remove dropout features
# TODO: decide on subset matrix
```
```{r}
ax <- ggplot() +
  geom_point(
    data = list_cells[[1]]$RNA@meta.features,
    aes(x = nzmean, y = pct_dropout),
    color = "blue", pch = 1
  ) +
  geom_point(
    data = list_cells[[2]]$RNA@meta.features,
    aes(x = nzmean, y = pct_dropout),
    color = "red", pch = 1
  ) +
  xlim(0, 10)
file <- "tmp/zheng-pct_dropout-nzmean.png"
ggsave(file, ax, width = 5, height = 5)
```
```{r}
counts <- GetAssayData(halfmix, "counts")
metafeatures <- data.frame(
  pct_dropout = rowSums(counts == 0) / ncol(counts),
  nzmean = mean_nonzero(counts),
  row.names = rownames(counts)
)
threshold <- 10
ax <- ggplot(metafeatures) +
  geom_point(
    aes(x = nzmean, y = pct_dropout),
    pch = 1
  ) +
  xlim(0, 10)
file <- "tmp/halfmix-pct_dropout-nzmean.pdf"
ggsave(file, ax, width = 5, height = 5)
```
```{r}
x <- counts[, 1]
hist(x[x > 0 & x < 150])
length(x[x == 8])
# head(unname(sort(x, decreasing = TRUE)), 100)
```
# Plot
## PCA
```{r}
halfmix <- NormalizeData(halfmix)
halfmix <- FindVariableFeatures(halfmix)
halfmix <- ScaleData(halfmix, do.scale = FALSE)
halfmix <- RunPCA(halfmix)
saveRDS(halfmix, "data/293t_jurkat/processed/halfmix-pca.rds")
```
```{r}
ax <- PCAPlot(halfmix, shuffle = TRUE)
file <- "tmp/pca-halfmix.png"
ggsave(file, ax, width = 5, height = 5)
```
```{r}
halfmix <- RunUMAP(halfmix, dims = 1:20)
ax <- DimPlot(halfmix, reduction = "umap")
file <- "tmp/umap-halfmix.png"
ggsave(file, ax, width = 5, height = 5)
```
```{r}
```

# TODO: Run metrics and plot PCA