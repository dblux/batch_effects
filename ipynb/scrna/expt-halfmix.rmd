```{r}
library(Seurat)
library(magrittr)
library(ggplot2)
library(cowplot)
theme_set(theme_bw())

library(AnnotationDbi)
library(org.Hs.eg.db)

src_files <- list.files("R", full.names = TRUE)
for (f in src_files) {
  source(f)
  cat(sprintf('Sourced file: %s\n', f))
}
```
```{r}
halfmix <- readRDS("data/jurkat_293t/processed/halfmix.rds")
```
```{r}
# Map ensembl id to gene symbol
mapping <- mapIds(
  org.Hs.eg.db,
  keys = rownames(halfmix),
  keytype = "ENSEMBL",
  column = "SYMBOL"
)
print(sum(grepl("^MT-", mapping)))
ribo_genes <- rownames(halfmix)[grep("^RP[SL]", mapping)]
halfmix$percent_ribo <-
  colSums(GetAssayData(halfmix, slot = "counts")[ribo_genes, ]) /
  halfmix$nCount_RNA
```
# QC
```{r}
FeatureScatter(
  halfmix_sub,
  feature1 = "nCount_RNA", feature2 = "nFeature_RNA",
  group.by = "batch", shuffle = TRUE
)
FeatureScatter(
  halfmix_sub,
  feature1 = "nCount_RNA", feature2 = "percent_ribo",
  group.by = "batch", shuffle = TRUE
)
```
```{r}
ax <- VlnPlot(
  halfmix,
  features = c("percent_ribo", "nCount_RNA"),
  group.by = "batch",
  pt.size = .2
)
ax
# file <- "tmp/halfmix_celltype-nfeature.png"
# ggsave(file, ax, width = 6, height = 6)
```
- Only ribo genes present, no mito genes
```{r}
halfmix_sub <- subset(
  halfmix,
  subset = nFeature_RNA > 1500 &
    nCount_RNA < 3e4 &
    percent_ribo > 0.25
)
table(halfmix_sub$celltype, halfmix_sub$batch)
head(colnames(halfmix))
```
# Feature selection: Remove ribo and sparse genes
```{r}
sparse_genes <- remove_sparse(
  GetAssayData(halfmix_sub, "counts"),
  0.95, halfmix_sub$celltype,
  ret.features = TRUE
)
rm_genes <- union(ribo_genes, sparse_genes)
halfmix_sel <- halfmix_sub[!(rownames(halfmix_sub) %in% rm_genes), ]
table(halfmix_sel$celltype, halfmix_sel$batch)
```
# Subset
```{r}
# With batch effects
tabnames <- list(unique(halfmix_sel$celltype), unique(halfmix_sel$batch))
ct_bal <- matrix(
  c(800, 800, 0, 800, 800, 0),
  2, 3, dimnames = tabnames
)
ct_imbal1 <- matrix(
  c(400, 1200, 0, 400, 1200, 0),
  2, 3, dimnames = tabnames
)
ct_imbal2 <- matrix(
  c(1200, 400, 0, 1200, 400, 0),
  2, 3, dimnames = tabnames
)
# With batch effects
idx_bal <- idx_imbal1 <- idx_imbal2 <- numeric()
for (g in rownames(ct_bal)) {
  for (k in colnames(ct_bal)) {
    j_kg <- which(halfmix_sel$batch == k & halfmix_sel$celltype == g)
    if (length(j_kg) == 0)
      next
    # balanced data set
    n1_kg <- ct_bal[g, k]
    j1_kg <- sample(j_kg, n1_kg)
    idx_bal <- c(idx_bal, j1_kg)
    # imbalanced data set
    n2_kg <- ct_imbal1[g, k]
    j2_kg <- sample(j_kg, n2_kg)
    idx_imbal1 <- c(idx_imbal1, j2_kg)
    # imbalanced data set
    n3_kg <- ct_imbal2[g, k]
    j3_kg <- sample(j_kg, n3_kg)
    idx_imbal2 <- c(idx_imbal2, j3_kg)
  }
}
halfmix_bal <- halfmix_sel[, idx_bal]
halfmix_imbal1 <- halfmix_sel[, idx_imbal1]
halfmix_imbal2 <- halfmix_sel[, idx_imbal2]
print(table(halfmix_bal$celltype, halfmix_bal$batch))
print(table(halfmix_imbal1$celltype, halfmix_imbal1$batch))
print(table(halfmix_imbal2$celltype, halfmix_imbal2$batch))
```
```{r}
# Without batch effects
tabnames <- list(unique(halfmix_sel$celltype), 1:3)
ct_bal <- matrix(
  c(600, 600, 0, 600, 600, 0),
  2, 3, dimnames = tabnames
)
ct_imbal <- matrix(
  c(300, 900, 0, 300, 900, 0),
  2, 3, dimnames = tabnames
)
halfmix_b1 <- subset(halfmix_sel, subset = batch == "zheng")

idx_bal <- idx_imbal <- numeric()
batch_bal <- batch_imbal <- rep(NA, ncol(halfmix_b1))
for (g in rownames(ct_bal)) {
  j1_g <- j2_g <- which(halfmix_b1$celltype == g)
  for (k in colnames(ct_bal)) {
    # balanced data
    n1_kg <- ct_bal[g, k]
    j1_kg <- sample(j1_g, n1_kg)
    j1_g <- setdiff(j1_g, j1_kg)
    idx_bal <- c(idx_bal, j1_kg)
    batch_bal[j1_kg] <- k
    # imbalanced data
    n2_kg <- ct_imbal[g, k]
    j2_kg <- sample(j2_g, n2_kg)
    j2_g <- setdiff(j2_g, j2_kg)
    idx_imbal <- c(idx_imbal, j2_kg)
    batch_imbal[j2_kg] <- k
  }
}
halfmix_b1_bal <- halfmix_b1[, idx_bal]
halfmix_b1_bal$batch <- batch_bal[idx_bal]
halfmix_b1_imbal <- halfmix_b1[, idx_imbal]
halfmix_b1_imbal$batch <- batch_imbal[idx_imbal]
table(halfmix_b1_bal$celltype, halfmix_b1_bal$batch)
table(halfmix_b1_imbal$celltype, halfmix_b1_imbal$batch)
```
# Plot
## PCA
```{r}
halfmix_sub1 <- halfmix_sub %>%
  NormalizeData() %>%
  FindVariableFeatures() %>%
  ScaleData(do.scale = FALSE) %>%
  RunPCA()
ax <- DimPlot(halfmix_sub1, reduction = "pca")
file <- "tmp/pca-halfmix.png"
ggsave(file, ax, width = 5, height = 5)
```
```{r}
halfmix <- RunUMAP(halfmix, dims = 1:20)
ax <- DimPlot(halfmix, reduction = "umap")
file <- "tmp/umap-halfmix.png"
ggsave(file, ax, width = 5, height = 5)
```